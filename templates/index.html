<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ¸ ç½‘æ‡¿äº‘ç›˜ - å°å¯çˆ±çš„æ–‡ä»¶ä¸–ç•Œ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body class="main-body">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1>ç½‘æ‡¿äº‘ç›˜</h1>
                <span class="subtitle">æ–‡ä»¶ç®¡ç†ä¸–ç•Œ</span>
            </div>
            <div class="user-info">
                <span class="welcome">æ¬¢è¿ï¼Œ{{ current_user.username }}ï¼</span>
                <a href="{{ url_for('logout') }}" class="logout-btn">é€€å‡ºç™»å½•</a>
            </div>
        </div>
    </header>

    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    <nav class="breadcrumb">
        <div class="breadcrumb-content">
            {% for crumb in breadcrumbs %}
                {% if loop.last %}
                    <span class="breadcrumb-item current">{{ crumb.name }}</span>
                {% else %}
                    <a href="{{ url_for('index', path=crumb.path) }}" class="breadcrumb-item">{{ crumb.name }}</a>
                    <span class="breadcrumb-separator">></span>
                {% endif %}
            {% endfor %}
        </div>
    </nav>

    <!-- æ¶ˆæ¯æç¤º -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else 'error' if category == 'error' else 'info' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
    <div class="actions">
        <div class="action-buttons">
            <button class="action-btn primary" onclick="document.getElementById('fileInput').click()">
                ä¸Šä¼ æ–‡ä»¶
            </button>
            <button class="action-btn secondary" onclick="showCreateFolder()">
                æ–°å»ºæ–‡ä»¶å¤¹
            </button>
            <button class="action-btn info" onclick="refreshPage()">
                åˆ·æ–°é¡µé¢
            </button>
        </div>
    </div>

    <!-- æ–‡ä»¶ä¸Šä¼ è¡¨å• -->
    <form id="uploadForm" action="{{ url_for('upload_file') }}" method="POST" enctype="multipart/form-data" style="display: none;">
        <input type="hidden" name="path" value="{{ current_path }}">
        <input type="file" id="fileInput" name="file" multiple onchange="submitUpload()">
    </form>

    <!-- ä¸Šä¼ è¿›åº¦æ¡ -->
    <div id="uploadProgress" class="progress-container" style="display: none;">
        <div class="progress-header">
            <h3>æ–‡ä»¶ä¸Šä¼ ä¸­</h3>
            <button class="progress-close" onclick="hideUploadProgress()">Ã—</button>
        </div>
        <div class="progress-content">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text">
                <span id="progressText">0%</span>
                <span id="progressStatus">å‡†å¤‡ä¸Šä¼ ...</span>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºæ–‡ä»¶å¤¹è¡¨å• -->
    <form id="createFolderForm" action="{{ url_for('create_folder') }}" method="POST" style="display: none;">
        <input type="hidden" name="path" value="{{ current_path }}">
        <input type="text" id="folderNameInput" name="folder_name" placeholder="è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°ï½">
    </form>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <div class="file-container">
            <!-- æ–‡ä»¶å¤¹åˆ—è¡¨ -->
            {% if folders %}
                <div class="section">
                    <h2 class="section-title">æ–‡ä»¶å¤¹</h2>
                    <div class="file-grid">
                        {% for folder in folders %}
                            <div class="file-item folder">
                                <div class="file-icon">ğŸ“</div>
                                <div class="file-info">
                                    <div class="file-name">{{ folder.name }}</div>
                                    <div class="file-meta">åˆ›å»ºæ—¶é—´ï¼š{{ folder.created }}</div>
                                </div>
                                <div class="file-actions">
                                    <a href="{{ url_for('index', path=folder.path) }}" class="action-link">æ‰“å¼€</a>
                                    <button class="action-link delete" onclick="deleteItem('{{ folder.path }}', 'æ–‡ä»¶å¤¹')">åˆ é™¤</button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            {% if files %}
                <div class="section">
                    <h2 class="section-title">æ–‡ä»¶</h2>
                    <div class="file-grid">
                        {% for file in files %}
                            {% if file.type == 'image' %}
                                <!-- å›¾ç‰‡ç›´æ¥æ˜¾ç¤º -->
                                <div class="file-item image-preview-item">
                                    <div class="image-preview">
                                        <img src="{{ url_for('serve_file', filepath=file.path) }}" 
                                             alt="{{ file.name }}" 
                                             class="file-image"
                                             onclick="openImagePreview('{{ url_for('serve_file', filepath=file.path) }}', '{{ file.name }}')">
                                    </div>
                                    <div class="file-info">
                                        <div class="file-name">{{ file.name }}</div>
                                        <div class="file-meta">
                                            å¤§å°ï¼š{{ file.size }} | åˆ›å»ºæ—¶é—´ï¼š{{ file.created }}
                                        </div>
                                    </div>
                                    <div class="file-actions">
                                        <button class="action-link" onclick="downloadFile('{{ file.path }}', '{{ file.name }}')">ä¸‹è½½</button>
                                        <button class="action-link share" onclick="showShareOptions('{{ file.path }}', '{{ file.name }}', 'image')">åˆ†äº«</button>
                                        <button class="action-link delete" onclick="deleteItem('{{ file.path }}', 'æ–‡ä»¶')">åˆ é™¤</button>
                                    </div>
                                </div>
                            {% else %}
                                <!-- å…¶ä»–æ–‡ä»¶ç±»å‹ -->
                                <div class="file-item file">
                                    <div class="file-icon">
                                        {% if file.type == 'video' %}ğŸ¬
                                        {% elif file.type == 'audio' %}ğŸµ
                                        {% elif file.type == 'text' %}ğŸ“
                                        {% elif file.type == 'archive' %}ğŸ“¦
                                        {% else %}ğŸ“„
                                        {% endif %}
                                    </div>
                                    <div class="file-info">
                                        <div class="file-name">{{ file.name }}</div>
                                        <div class="file-meta">
                                            å¤§å°ï¼š{{ file.size }} | åˆ›å»ºæ—¶é—´ï¼š{{ file.created }}
                                        </div>
                                    </div>
                                    <div class="file-actions">
                                        {% if '.txt' in file.path or '.sh' in file.path %}
                                            <a href="{{ url_for('preview_file', filepath=file.path) }}" class="action-link">é¢„è§ˆ</a>
                                        {% endif %}
                                        {% if file.type == 'video' or file.type == 'audio' %}
                                            <a href="{{ url_for('preview_file', filepath=file.path) }}" class="action-link">é¢„è§ˆ</a>
                                        {% endif %}
                                        {% if file.type == 'archive' %}
                                            <a href="{{ url_for('extract_file', filepath=file.path) }}" class="action-link">è§£å‹</a>
                                        {% endif %}
                                        <button class="action-link" onclick="downloadFile('{{ file.path }}', '{{ file.name }}')">ä¸‹è½½</button>
                                        <button class="action-link share" onclick="showShareOptions('{{ file.path }}', '{{ file.name }}', '{{ file.type }}')">åˆ†äº«</button>
                                        <button class="action-link delete" onclick="deleteItem('{{ file.path }}', 'æ–‡ä»¶')">åˆ é™¤</button>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- ç©ºçŠ¶æ€ -->
            {% if not folders and not files %}
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“</div>
                    <h3>è¿™é‡Œè¿˜æ˜¯ç©ºçš„</h3>
                    <p>å¿«æ¥ä¸Šä¼ ä¸€äº›æ–‡ä»¶æˆ–è€…åˆ›å»ºæ–‡ä»¶å¤¹å§ï¼</p>
                    <div class="empty-actions">
                        <button class="action-btn primary" onclick="document.getElementById('fileInput').click()">
                            ä¸Šä¼ æ–‡ä»¶
                        </button>
                        <button class="action-btn secondary" onclick="showCreateFolder()">
                            æ–°å»ºæ–‡ä»¶å¤¹
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>
    </main>

    <!-- åˆ é™¤ç¡®è®¤å¯¹è¯æ¡† -->
    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¡®è®¤åˆ é™¤</h3>
            </div>
            <div class="modal-body">
                <p>ç¡®å®šè¦åˆ é™¤è¿™ä¸ª <span id="deleteType"></span> å—ï¼Ÿ</p>
                <p class="warning">åˆ é™¤åæ— æ³•æ¢å¤</p>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" onclick="hideDeleteModal()">å–æ¶ˆ</button>
                <button class="action-btn danger" onclick="confirmDelete()">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºæ–‡ä»¶å¤¹å¯¹è¯æ¡† -->
    <div id="folderModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–°å»ºæ–‡ä»¶å¤¹</h3>
            </div>
            <div class="modal-body">
                <input type="text" id="folderNameModal" placeholder="è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°" class="form-input">
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" onclick="hideFolderModal()">å–æ¶ˆ</button>
                <button class="action-btn primary" onclick="createFolder()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡å…¨å±é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="imagePreviewModal" class="image-preview-modal" style="display: none;">
        <div class="image-preview-content">
            <button class="image-preview-close" onclick="closeImagePreview()">Ã—</button>
            <img id="previewImage" src="" alt="">
        </div>
    </div>

    <!-- åˆ†äº«é€‰é¡¹å¯¹è¯æ¡† -->
    <div id="shareModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>åˆ†äº«æ–‡ä»¶</h3>
                <span id="shareFileName"></span>
            </div>
            <div class="modal-body">
                <div class="share-options" id="shareOptions">
                    <!-- åŠ¨æ€å†…å®¹å°†é€šè¿‡JavaScriptå¡«å…… -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" onclick="hideShareModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ä¸‹è½½è¿›åº¦æ¡ -->
    <div id="downloadProgress" class="progress-container" style="display: none;">
        <div class="progress-header">
            <h3>æ–‡ä»¶ä¸‹è½½ä¸­</h3>
            <button class="progress-close" onclick="hideDownloadProgress()">Ã—</button>
        </div>
        <div class="progress-content">
            <div class="progress-bar">
                <div class="progress-fill" id="downloadProgressFill"></div>
            </div>
            <div class="progress-text">
                <span id="downloadProgressText">0%</span>
                <span id="downloadProgressStatus">å‡†å¤‡ä¸‹è½½...</span>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
